<html>
<head>
	<script src="../matter.js"></script>
	<script src="../polygons.js"></script>
	<script src="../object.js"></script>
	<script src="../world.js"></script>
</head>
<body style="color:white; background-color:black; margin:0; padding:0; text-align:center;">
	<canvas id="canvas" width="600px" height="600px"></canvas>
	<p>click and drag onto a physics object to create a constraint</p>
	<script type="text/javascript">
		var canvas = document.getElementById("canvas");
		var context = canvas.getContext("2d");
		var testWorld;
		var canUpdate = true;
		var objects = [];
		var constraints = [];
		var startDrag = null;
		var endDrag = new vec2();
		
		canvas.addEventListener("mousedown", mousedown);
		canvas.addEventListener("mousemove", mousemove);
		canvas.addEventListener("mouseup", mouseup);
		
		function init(){
			testWorld = world.withBounds(box.canvasBounds(canvas), false);
			testWorld.removeTerrain(testWorld.terrain[2]);
			addBody();
		}
		function update(){
			if(canUpdate)
				testWorld.update(16.66667);
			draw();
			window.requestAnimationFrame(update);
			
			for(var i = objects.length - 1; i >= 0; i--){
				if(objects[i].getPos().y >= 600){
					testWorld.remove(objects[i]);
					addBody();
					objects.splice(i, 1);
				}
			}
		}
		function draw(){
			context.fillStyle = "#333";
			context.fillRect(0, 0, canvas.width, canvas.height);
			
			
			testWorld.draw(context);
			
			// draw constraint that user is about to create
			if(startDrag){
				ray.fromPoints(startDrag, endDrag).draw(context, "#0F0", 1);
			}
			
			//draw constaints
			for(var i = constraints.length - 1; i >= 0; i--){
				var tposA = constraints[i].bodyA ? vec2.fromAnonObj(constraints[i].bodyA.position).plus(constraints[i].pointA) : constraints[i].pointA;
				var tposB = constraints[i].bodyB ? vec2.fromAnonObj(constraints[i].bodyB.position).plus(constraints[i].pointB) : constraints[i].pointB;
				ray.fromPoints(tposA, tposB).draw(context, "#0F0", 2);
			}
		}
		function addBody(){
			var pos = new vec2(Math.random() * 500 + 50, 0);
			var b = object.default();
			b.setPos(pos);
			testWorld.add(b);
			objects.push(b);
		}
		
		function mousedown(e){
			canUpdate = false;
			startDrag = new vec2(e.offsetX, e.offsetY);
		}
		function mousemove(e){
			endDrag = new vec2(e.offsetX, e.offsetY);
		}
		function mouseup(e){
			canUpdate = true;
			endDrag = new vec2(e.offsetX, e.offsetY);
			
			var c = testWorld.createConstraint(startDrag, endDrag);
			if(c) {
				constraints.push(c);
				addBody();
			}
			startDrag = null;
		}
		
		init();
		update();
	</script>
</body>
</html>